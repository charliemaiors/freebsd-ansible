---
- name: Compile userland
  make: 
    chdir: /usr/src
    target: buildworld
    params:
      - "{{ item.key }}": "{{ item.value }}"
  with_dict:
    - build_common
  when: base_compile or src_updated
  register: userland_builded
- name: Compile kernel
  make:
    chdir: /usr/src
    target: kernel
    params:
      - "{{ item.key }}": "{{ item.value }}"
    with_dict:
      - "{{ build_common | combine (kernel_extra_params) }}"
      
  when: kernel_opts or base_compile
- name: Reboot and wait for reboot
  reboot:
    reboot_timeout: 3600
    msg: Reboot initiated Kernel upgrade
  when: kernel_opts or base_compile
- name: Install userland
  make:
    chdir: /usr/src
    target: installworld
    params:
      - "{{ item.key }}": "{{ item.value }}"
  with_dict:
    - build_common
  when: base_compile or src_updated
  